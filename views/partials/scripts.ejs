<script src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
<script src="/scripts/nv.d3.min.js"></script>
<script>
	function unxConverter(ele) {
		var unxdate = $(ele).text();
		var date = new Date(unxdate*1000);
		var hours = date.getHours();
		var mins = date.getMinutes();
		var newDate = hours + ":" + mins; 
		$(ele).text(newDate);
	}
	function listTown() {
		var townsList = ["Port Moresby","Lae","Arawa","Mount Hagen","Madang","Wewak","Goroka","Kokopo","Popondetta","Aitape","Rabaul","Kimbe","Tabubil","Daru","Kavieng","Alotau","Vanimo","Bulolo","Kiunga","Kundiawa","Mendi","Kainantu","Lorengau","Ialibu","Kerema","Ningerum","Wau","Wabag","Rabaul"];
		for (var i=0; i<townsList.length; i++) {
			$(".towns-list-group")
			.append("<li class='town "+townsList[i]+"'><a href='/"+townsList[i]+"' class='btn btn-primary'>"+townsList[i]+"</a></li>");
		}
	}
	function getForecast(callback) {
		$.get("/forecast/lae", function (data) {
			callback(data);
		})
	}
	nv.addGraph({
		generate: function() {
			var width = nv.utils.windowSize().width() - 40,
				height = nv.utils.windowSize().height() - 40;
			
			var chart = nv.models.line()
				.width(width)
				.height(height)
				.margin({
					top: 20,
					right: 20,
					bottom: 20,
					left: 20
				})
				
			chart.dispatch.on("renderEnd", function() { console.log("render complete")});
			
			d3.select("#forecast-graph")
				.attr("width", width)
				.attr("height", height)
				.data(getForecast((data) => {
					return [{
						value: data.list.deg,
						key: "temp"
					}]
					// return JSON.stringify(data.list);
				}))
				// .datum(getForecast((data) => {return JSON.stringify(data.list);}))
				.call(chart);
			
			return chart;
		},
		callback: function(graph) {
			window.onresize = function() {
                var width = nv.utils.windowSize().width - 40,
                    height = nv.utils.windowSize().height - 40,
                    margin = graph.margin();
                if (width < margin.left + margin.right + 20)
                    width = margin.left + margin.right + 20;
                if (height < margin.top + margin.bottom + 20)
                    height = margin.top + margin.bottom + 20;
                graph.width(width).height(height);
                d3.select('#forecast-graph')
                    .attr('width', width)
                    .attr('height', height)
                    .call(graph);
            };
		}
	})
	$(document).ready(function() {
		unxConverter(".date-sunset");
		unxConverter(".date-sunrise");
		unxConverter(".date-update");
		listTown();
		getForecast(function(data){
			console.log(data)
		});
	});
	
</script>